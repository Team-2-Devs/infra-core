_format_version: "3.0"

upstreams:
  - name: graph-gateway-auth-upstream
    targets:
      - target: oauth2-proxy:4180
        weight: 100

services:
  # Auth-guarded GraphQl via oauth2-proxy â†’ teaapi
  - name: graph-gateway
    host: graph-gateway-auth-upstream
    protocol: http
    port: 4180
    routes:
      - name: graph-gateway-graphql
        paths: ["/graphql"]
        strip_path: false
        protocols: ["http","https"]
        request_buffering: false
        response_buffering: false
        plugins:
          - name: rate-limiting
            config:
              second: 5
              minute: 60
              policy: redis # consistent rate-limits globally
              redis_host: redis
              redis_port: 6379
  # Direct health route to graph-gatway so Kong can ping without a token
  - name: graph-gateway-health
    url: http://graph-gateway:8080
    routes:
      - name: graph-gateway-health
        paths: ["/health"]
        strip_path: false
        protocols: ["http","https"]